scp ${process.env.HOME}/.ssh/id_rsa.pub ${config.mikrotik.default_username}@${config.mikrotik.default_ip}:/
ssh ${config.mikrotik.default_username}@${config.mikrotik.default_ip} << EOF
    /system routerboard settings set baud-rate=off
    /ip service set www port=${config.mikrotik.webfig_port}

    /interface ethernet set ${config.mikrotik.wan_interface} mac-address=${config.mikrotik.mac_address}

    /ip address add address=${config.mikrotik.ip_address}/${config.mikrotik.subnet_mask} interface=${config.mikrotik.wan_interface}

    /ip route add gateway=${config.mikrotik.gateway}

    /ip dns set servers=${config.mikrotik.dns_servers}

    /ip firewall nat add chain=dstnat action=dst-nat to-addresses=${config.mikrotik.nat_destination_ip} protocol=tcp in-interface=ether1 dst-port=${config.mikrotik.tcp_nat.join(',')} log=no
    /ip firewall nat add chain=dstnat action=dst-nat to-addresses=${config.mikrotik.nat_destination_ip} protocol=udp in-interface=ether1 dst-port=${config.mikrotik.udp_nat.join(',')} log=no

    /ip firewall nat add chain=dstnat action=dst-nat to-addresses=${config.mikrotik.nat_destination_ip} protocol=tcp dst-address=${config.mikrotik.ip_address} dst-port=${config.mikrotik.tcp_nat.join(',')} log=no log-prefix="" 
    /ip firewall nat add chain=srcnat action=masquerade protocol=tcp src-address=192.168.88.0/24 dst-address=${config.mikrotik.nat_destination_ip} out-interface=bridge dst-port=${config.mikrotik.tcp_nat.join(',')} log=no log-prefix="" 

    /user add name=${process.env.LOGNAME} group=full comment="Username matching host machine's active user" disabled=no  
    /user ssh-keys import public-key-file=id_rsa.pub user=${process.env.LOGNAME}

    /interface wireless security-profiles add name=guests authentication-types=wpa2-psk mode=dynamic-keys wpa2-pre-shared-key=${config.mikrotik.guest_wifi.password}
    /interface wireless set wlan1 ssid=${config.mikrotik.guest_wifi.ssid} security-profile=guests 

    /interface wireless security-profiles add name=${process.env.LOGNAME} authentication-types=wpa2-psk mode=dynamic-keys wpa2-pre-shared-key=${config.mikrotik.main_wifi.password}
    /interface wireless set wlan2 ssid=${config.mikrotik.main_wifi.ssid} security-profile=${process.env.LOGNAME} 

    ${config.mikrotik.dhcp_static.map(machine => `/ip dhcp-server lease add address=${machine.ip} mac-address=${machine.mac} comment="${machine.comment}"`).join("\n    ")}
    
EOF